import { Trip_Schedule } from "../../BE/Trip_Scheduling.js";
import { searchDriverByInfo } from "../../BE/driverDatabaseInteract.js";
import { DefaultsearchVehicle } from "../../BE/fetchVehicle.js";
import { searchVehicle } from "../../BE/fetchVehicle.js";
var drivers = [
    {
        plateNumber: '29B-12345',
        mainDriver: 'T√†i x·∫ø 1',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 1',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM',
        type: 'Xe kh√°ch',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 2',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 2',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe t·∫£i',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 3',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 3',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe kh√°ch',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 4',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 3',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe kh√°ch',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 5',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 3',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe t·∫£i',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 6',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 3',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe container',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 7',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 3',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe container',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 6',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 3',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe container',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 6',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 3',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe container',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    {
        plateNumber: '29B-12346',
        mainDriver: 'T√†i x·∫ø 6',
        mainDriverDOB: '01/01/1980',
        mainDriverHometown: 'H√† N·ªôi',
        mainDriverPhone: '0123456789',
        assistantDriver: 'Ph·ª• xe 3',
        assistantDriverDOB: '02/02/1985',
        assistantDriverHometown: 'H·∫£i Ph√≤ng',
        assistantDriverPhone: '0987654321',
        route: 'H√† N·ªôi - TP.HCM2',
        type: 'Xe container',
        mainDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        assistantDriverPhoto: 'https://photocross.net/wp-content/uploads/2020/03/anh-chan-dung.jpg',
        imageUrl: ['https://via.placeholder.com/150', 'https://via.placeholder.com/150', 'https://via.placeholder.com/150']
    },
    // C√°c d·ªØ li·ªáu m·∫´u kh√°c...
];

var filteredDrivers = [];
var currentDriverIndex = null;

// Function hi·ªÉn th·ªã profile c·ªßa t√†i x·∫ø v√† ph·ª• xe
async function showProfile(index) {
    var trip = newTrips[index];
    currentDriverIndex = index;
    const car = await searchVehicle("control_Plate", trip.car_Id);
    const drDocs = await searchDriverByInfo("id", trip.driver_Id);
    const subDocs = await searchDriverByInfo("id", trip.subDriver_Id);
    const vh = car.docs[0].data();
    console.log("üöÄ ~ file: search_using.js:348 ~ vh:", vh);
    const dr = drDocs[0].data();
    console.log("üöÄ ~ file: search_using.js:352 ~ dr:", dr);
    const sub = subDocs[0].data();
    console.log("üöÄ ~ file: search_using.js:356 ~ sub:", sub);
    var route = "";
    if (trip.start_Dest != "") {
        route += " T·ª´ " + trip.start_Dest
    }
    if (trip.end_Dest != "") {
        route += " ƒê·∫øn " + trip.end_Dest;
    }
    document.getElementById('profile-name').textContent = "Bi·ªÉn S·ªë Xe: " + vh.control_Plate;
    document.getElementById('profile-type').textContent = "Lo·∫°i Xe: " + (vh.VehicleType == 1 ? "Xe T·∫£i" : vh.VehicleType == 2 ? "Xe Kh√°ch" : "Containers");
    document.getElementById('profile-phone').textContent = "Li√™n l·∫°c 1: " + dr.phoneNumber + "\n Li√™n l·∫°c 2: " + sub.phoneNumber;
    document.getElementById('profile-route').textContent = "L·ªô Tr√¨nh: " + (route != ""? route: "ƒêang c·∫≠p nh·∫≠t");

    var profileImages = document.getElementById('profile-images');
    profileImages.innerHTML = '';
    var imgList = [vh.front_image, vh.back_image];
    imgList.forEach(function (imageUrl) {
        var img = document.createElement('img');
        img.src = imageUrl;
        img.onclick = function () {
            window.open(imageUrl, '_blank');
        };
        profileImages.appendChild(img);
    });

    // Hi·ªÉn th·ªã th√¥ng tin t√†i x·∫ø v√† ph·ª• xe
    document.getElementById('profile-driver-name').textContent = "T√™n T√†i X·∫ø: " + dr.name;
    document.getElementById('profile-driver-dob').textContent = "Ng√†y Sinh: " + dr.DoB;
    document.getElementById('profile-driver-hometown').textContent = "Hi·ªáu Qu·∫£: " + (dr.efficiency == null ? "" : dr.efficiency);
    document.getElementById('profile-driver-photo').src = dr.idCard;

    document.getElementById('profile-assistant-name').textContent = "T√™n Ph·ª• Xe: " + sub.name;
    document.getElementById('profile-assistant-dob').textContent = "Ng√†y Sinh: " + sub.DoB;
    document.getElementById('profile-assistant-hometown').textContent = "Hi·ªáu Qu·∫£: " + (dr.efficiency == null ? "" : dr.efficiency);
    document.getElementById('profile-assistant-photo').src = sub.idCard;
    document.querySelector('.profile-container').style.display = 'block';
    document.querySelector('.overlay').style.display = 'block'; // Show overlay
}

// Function ƒë√≥ng profile
function closeProfile() {
    document.querySelector('.profile-container').style.display = 'none';
    document.querySelector('.overlay').style.display = 'none'; // Hide overlay
}
document.querySelector('.overlay').addEventListener('click', function () {
    closeProfile();
})

// Function m·ªü form ch·ªânh s·ª≠a
// Function m·ªü form ch·ªânh s·ª≠a
function editProfile() {
    var driver = filteredDrivers[currentDriverIndex];
    document.getElementById('edit-main-driver').value = driver.mainDriver;
    document.getElementById('edit-main-driver-dob').value = driver.mainDriverDOB;
    document.getElementById('edit-main-driver-hometown').value = driver.mainDriverHometown;
    document.getElementById('edit-assistant-driver').value = driver.assistantDriver;
    document.getElementById('edit-assistant-driver-dob').value = driver.assistantDriverDOB;
    document.getElementById('edit-assistant-driver-hometown').value = driver.assistantDriverHometown;
    document.getElementById('edit-main-driver-phone').value = driver.mainDriverPhone;
    document.getElementById('edit-assistant-driver-phone').value = driver.assistantDriverPhone;
    document.getElementById('edit-main-driver-photo').value = driver.mainDriverPhoto;
    document.getElementById('edit-assistant-driver-photo').value = driver.assistantDriverPhoto;
    document.querySelector('.edit-form').style.display = 'block';
    document.querySelector('.profile-container').style.display = 'none';

}
// Th√™m s·ª± ki·ªán click v√†o overlay
document.querySelector('.overlay').addEventListener('click', function () {
    // ƒê√≥ng b·∫£ng profile
    document.querySelector('.profile-container').style.display = 'none';
    // ƒê√≥ng form ch·ªânh s·ª≠a
    document.querySelector('.edit-form').style.display = 'none';
    // ·∫®n overlay
    this.style.display = 'none';
});


// Function h·ªßy ch·ªânh s·ª≠a
function cancelEdit() {
    document.querySelector('.edit-form').style.display = 'none';
    document.querySelector('.profile-container').style.display = 'block';
}


// Function c·∫≠p nh·∫≠t th√¥ng tin t√†i x·∫ø
function updateDriver() {
    var driver = filteredDrivers[currentDriverIndex];
    driver.mainDriver = document.getElementById('edit-main-driver').value;
    driver.assistantDriver = document.getElementById('edit-assistant-driver').value;
    driver.mainDriverPhone = document.getElementById('edit-main-driver-phone').value;
    driver.assistantDriverPhone = document.getElementById('edit-assistant-driver-phone').value;
    // driver.imageUrl[0] = document.getElementById('edit-image-url').value;
    // redraw()
    // C·∫≠p nh·∫≠t xong, ·∫©n form ch·ªânh s·ª≠a v√† hi·ªÉn th·ªã profile
    document.querySelector('.edit-form').style.display = 'none';
    document.querySelector('.profile-container').style.display = 'block';
    // Hi·ªÉn th·ªã th√¥ng tin c·∫≠p nh·∫≠t tr√™n profile
    document.getElementById('profile-name').textContent = "Bi·ªÉn s·ªë xe: " + driver.plateNumber;
    document.getElementById('profile-type').textContent = "Lo·∫°i xe: " + driver.type;
    document.getElementById('profile-phone').textContent = "S·ªë ƒëi·ªán tho·∫°i t√†i x·∫ø: " + driver.mainDriverPhone + ", S·ªë ƒëi·ªán tho·∫°i ph·ª• xe: " + driver.assistantDriverPhone;
    var profileImages = document.getElementById('profile-images');
    profileImages.innerHTML = '';
    driver.imageUrl.forEach(function (imageUrl) {
        var img = document.createElement('img');
        img.src = imageUrl;
        img.onclick = function () {
            window.open(imageUrl, '_blank');
        };
        profileImages.appendChild(img);
    });

    // Hi·ªÉn th·ªã th√¥ng tin t√†i x·∫ø v√† ph·ª• xe
    document.getElementById('profile-driver-name').textContent = "T√™n t√†i x·∫ø: " + driver.mainDriver;
    document.getElementById('profile-driver-dob').textContent = "Ng√†y sinh: " + driver.mainDriverDOB;
    document.getElementById('profile-driver-hometown').textContent = "Qu√™ qu√°n: " + driver.mainDriverHometown;
    document.getElementById('profile-driver-photo').src = driver.mainDriverPhoto;

    document.getElementById('profile-assistant-name').textContent = "T√™n ph·ª• xe: " + driver.assistantDriver;
    document.getElementById('profile-assistant-dob').textContent = "Ng√†y sinh: " + driver.assistantDriverDOB;
    document.getElementById('profile-assistant-hometown').textContent = "Qu√™ qu√°n: " + driver.assistantDriverHometown;
    document.getElementById('profile-assistant-photo').src = driver.assistantDriverPhoto;
}



// X·ª≠ l√Ω s·ª± ki·ªán khi nh·∫•n n√∫t t√¨m ki·∫øm

var trips = new Trip_Schedule();
var newTrips = [];
async function redraw() {
    var selectedType = document.getElementById('search-type').value.toLowerCase();
    var searchText = document.getElementById('search-text').value.toLowerCase();

    newTrips = []
    filteredDrivers = []
    let filterTrips = await trips.show_All();
    console.log("üöÄ ~ file: search_using.js:298 ~ filterTrips:", filterTrips);

    for (const trip of filterTrips) {
        console.log(trip);
        var result = await searchVehicle("control_Plate", trip.car_Id);
        if (result != null)
            result.forEach((vh) => {
                console.log("üöÄ ~ file: search_using.js:313 ~ vh:", vh.data());
                vh = vh.data();
                if ((vh.control_Plate.toLowerCase().includes(searchText) || searchText === '')
                    && (vh.VehicleType == selectedType || selectedType === '')) {
                    newTrips.push(trip);
                    console.log("üöÄ ~ file: search_using.js:311 ~ newTrips:", newTrips);
                }
            })
        console.log("üöÄ ~ file: search_using.js:314 ~ newTrips:", newTrips);

    }
    console.log("üöÄ ~ file:318", newTrips);

    // filteredDrivers = drivers.filter(function (driver) {
    //     return (driver.plateNumber.toLowerCase().includes(searchText) || searchText === '') && (driver.type.toLowerCase().includes(selectedType) || selectedType === '');
    // });

    var resultContainer = document.getElementById('result-container');
    resultContainer.innerHTML = '';

    if (newTrips.length > 0) {
        var table = document.createElement('table');
        table.id = 'result-table';

        var headerRow = table.insertRow();
        var headers = ['Lo·∫°i xe', 'Bi·ªÉn s·ªë xe', 'L√°i xe ch√≠nh', 'Ph·ª• xe', 'S·ªë ƒëi·ªán tho·∫°i', 'L·ªô tr√¨nh', 'H√¨nh ·∫£nh'];
        headers.forEach(function (header) {
            var th = document.createElement('th');
            th.textContent = header;
            headerRow.appendChild(th);
        });

        // for 
        newTrips.forEach(async function (trip, index) {
            console.log("üöÄ ~ file: search_using.js:341 ~ trip:", trip);
            const car = await searchVehicle("control_Plate", trip.car_Id);
            const drDocs = await searchDriverByInfo("id", trip.driver_Id);
            const subDocs = await searchDriverByInfo("id", trip.subDriver_Id);
            const vh = car.docs[0].data();
            console.log("üöÄ ~ file: search_using.js:348 ~ vh:", vh);
            const dr = drDocs[0].data();
            console.log("üöÄ ~ file: search_using.js:352 ~ dr:", dr);
            const sub = subDocs[0].data();
            console.log("üöÄ ~ file: search_using.js:356 ~ sub:", sub);

            var row = table.insertRow();
            var route = "";
            if (trip.start_Dest != "") {
                route += " T·ª´ " + trip.start_Dest
            }
            if (trip.end_Dest != "" && trip.end_Dest != trip.start_Dest) {
                route += " ƒê·∫øn " + trip.end_Dest;
            }
            var values = [((vh.VehicleType == 1) ? "Xe T·∫£i" : vh.VehicleType == 2 ? "Xe Kh√°ch" : "Container"), vh.control_Plate,
            dr.name, sub.name, dr.phoneNumber + ', ' + sub.phoneNumber,
                route, vh.front_image];
            values.forEach(function (value, i) {
                var cell = row.insertCell();
                if (i === 6) {
                    var img = document.createElement('img');
                    img.src = value;
                    img.style.maxWidth = '100px';
                    cell.appendChild(img);
                } else {
                    cell.textContent = value;
                }
            });
            row.addEventListener('click', function () {
                document.getElementById('overlay').style.display = 'block';
                showProfile(index);
            });
        });

        resultContainer.appendChild(table);
    } else {
        var noResult = document.createElement('p');
        noResult.textContent = 'Kh√¥ng t√¨m th·∫•y xe ph√π h·ª£p.';
        noResult.className = 'no-result-message'; // √Åp d·ª•ng class CSS m·ªõi
        resultContainer.appendChild(noResult);
    }
};
document.getElementById('search-btn').addEventListener('click', function () {
    redraw();
});
document.addEventListener('keypress', function (event) {
    var keycode = event.keyCode || event.which;
    if (keycode == '13') {
        redraw();
    }
});

redraw();

document.getElementById("cancel_btn").addEventListener('click', () => {
    cancelEdit()
})
document.getElementById("update_btn").addEventListener('click', () => {
    updateDriver()
})
document.getElementById("edit_btn").addEventListener('click', () => {
    editProfile();
})
document.getElementById("search-type").addEventListener('change', async function () {
    await redraw();
})